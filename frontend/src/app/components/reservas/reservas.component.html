<div *ngIf="showToast" class="toast-notification">
    <div class="toast-icon">✅</div>
    <div class="toast-content">
        <div class="toast-title">{{ isEditing ? '¡Cambios Guardados!' : '¡Reserva Confirmada!' }}</div>
        <div class="toast-message">{{ isEditing ? 'Tu reserva ha sido actualizada.' : 'Te esperamos en el Palacio.' }}
        </div>
    </div>
</div>

<div class="reservas-container">
    <h1>{{ isEditing ? 'Editar Reserva' : 'Reservar Sala' }}</h1>

    <p class="reservas-intro" *ngIf="sala">
        {{ isEditing ? 'Editando reserva en:' : 'Estás reservando:' }}
        <strong>{{ sala.nombre }}</strong>
    </p>

    <div class="calendar-container" *ngIf="sala">
        <div class="calendar-header">
            <button (click)="prevMonth()" aria-label="Mes anterior">Anterior</button>
            <!-- Aria-live for month announcement -->
            <h3 aria-live="polite" aria-atomic="true">{{ currentMonthName }} {{ currentYear }}</h3>
            <button (click)="nextMonth()" aria-label="Mes siguiente">Siguiente</button>
        </div>

        <div class="calendar-grid" role="grid"
            [attr.aria-label]="'Calendario de reservas ' + currentMonthName + ' ' + currentYear">
            <!-- Row for Weekday Headers -->
            <div class="calendar-row header-row" role="row">
                <div class="weekday" role="columnheader" aria-label="Domingo">Dom</div>
                <div class="weekday" role="columnheader" aria-label="Lunes">Lun</div>
                <div class="weekday" role="columnheader" aria-label="Martes">Mar</div>
                <div class="weekday" role="columnheader" aria-label="Miércoles">Mié</div>
                <div class="weekday" role="columnheader" aria-label="Jueves">Jue</div>
                <div class="weekday" role="columnheader" aria-label="Viernes">Vie</div>
                <div class="weekday" role="columnheader" aria-label="Sábado">Sáb</div>
            </div>

            <!-- Rows for Days -->
            <div class="calendar-row" role="row" *ngFor="let week of calendarWeeks; let w = index">
                <ng-container *ngFor="let day of week; let d = index">

                    <!-- Padding Cell (Empty) -->
                    <div *ngIf="day.isPadding" class="day empty" role="gridcell" aria-disabled="true">
                    </div>

                    <!-- Button Date Cell -->
                    <button *ngIf="!day.isPadding" #dayBtn type="button" class="day" role="gridcell"
                        [ngClass]="day.status" [class.selected]="isSelected(day.dateStr)"
                        [attr.aria-label]="day.fullLabel" [attr.aria-selected]="isSelected(day.dateStr)"
                        [attr.aria-disabled]="day.status !== 'available'" [tabindex]="getTabindex(day)"
                        (click)="selectDay(day)" (keydown)="onKeydown($event, day, w, d)">
                        {{ day.day }}
                    </button>

                </ng-container>
            </div>
        </div>

        <div class="calendar-legend" aria-hidden="true">
            <span class="legend-item"><span class="dot available"></span> Disponible</span>
            <span class="legend-item"><span class="dot occupied"></span> Ocupado</span>
            <span class="legend-item"><span class="dot selected"></span> Seleccionado</span>
        </div>
    </div>

    <form [formGroup]="reservaForm" (ngSubmit)="onSubmit()" class="form-section">
        <div class="form-group">
            <label for="fecha_evento">Fecha del Evento</label>
            <input type="text" id="fecha_evento" formControlName="fecha_evento" readonly />
            <div *ngIf="fechaOcupada" style="color: red;">La fecha seleccionada no está disponible.</div>
        </div>

        <div class="form-group">
            <label for="tipo_evento">Tipo de Evento</label>
            <select id="tipo_evento" formControlName="tipo_evento">
                <option value="Boda">Boda</option>
                <option value="Conferencia">Conferencia</option>
                <option value="Fiesta">Fiesta</option>
                <option value="Otro">Otro</option>
            </select>
        </div>

        <div class="form-group">
            <label for="numero_asistentes">Número de Asistentes (Mín: {{ minAsistentes }} - Máx: {{ sala?.capacidad
                }})</label>
            <input type="number" id="numero_asistentes" formControlName="numero_asistentes" [min]="minAsistentes" />
            <div *ngIf="reservaForm.controls['numero_asistentes'].errors?.['max']" style="color: red;">
                Excede la capacidad de la sala.
            </div>
            <div *ngIf="reservaForm.controls['numero_asistentes'].errors?.['min']" style="color: red;">
                El número de asistentes no puede ser inferior a {{ minAsistentes }}.
            </div>
        </div>

        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" formControlName="wantsServices" (change)="onServicesToggle()">
                ¿Desea contratar servicios adicionales?
            </label>
        </div>

        <div *ngIf="showContactFields" class="contact-fields-container">
            <p class="info-message">
                <span class="info-icon">ℹ️</span> Serán contactados para información acerca de servicios adicionales.
            </p>
            <div class="form-group">
                <label for="telefono_contacto">Teléfono de Contacto</label>
                <input type="tel" id="telefono_contacto" formControlName="telefono_contacto"
                    placeholder="+34 600 000 000" />
            </div>
            <div class="form-group">
                <label for="email_contacto">Email de Contacto</label>
                <input type="email" id="email_contacto" formControlName="email_contacto"
                    placeholder="ejemplo@correo.com" />
            </div>
        </div>

        <div *ngIf="error" style="color: red; text-align: center;">{{ error }}</div>

        <button type="submit" [disabled]="reservaForm.invalid || loading || fechaOcupada" class="submit-button">
            <span *ngIf="loading" class="spinner"></span>
            {{ loading ? 'Procesando...' : (isEditing ? 'Guardar Cambios' : 'Confirmar Reserva') }}
        </button>
    </form>
</div>